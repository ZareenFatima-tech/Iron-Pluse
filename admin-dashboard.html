<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard | Iron Pulse</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <link rel="stylesheet" href="css/style.css">
</head>

<body>
    <div class="container-fluid">
        <div class="row">
            <nav class="col-md-3 col-lg-2 d-md-block sidebar p-0">
                <div class="position-sticky pt-4">
                    <div class="text-center mb-4">
                        <h4 class="text-white fw-bold"><i class="bi bi-lightning-charge-fill text-primary"></i> ADMIN
                        </h4>
                    </div>
                    <ul class="nav flex-column">
                        <li class="nav-item"><a class="sidebar-link active" href="admin-dashboard.html"><i
                                    class="bi bi-graph-up me-2"></i> Analytics</a></li>
                        <li class="nav-item"><a class="sidebar-link" href="reports.html"><i
                                    class="bi bi-file-earmark-bar-graph me-2"></i> Reports</a></li>
                        <li class="nav-item"><a class="sidebar-link" href="index.html"><i class="bi bi-house me-2"></i>
                                Website Home</a></li>
                        <li class="nav-item mt-5"><button class="sidebar-link w-100 text-start border-0 bg-transparent"
                                id="logout-btn"><i class="bi bi-box-arrow-right me-2"></i> Logout</button></li>
                    </ul>
                </div>
            </nav>

            <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4 py-4">
                <div id="alert-container"></div>
                <div class="d-flex justify-content-between align-items-center pt-3 pb-2 mb-4">
                    <h1 class="h2">Admin Dashboard</h1>
                    <button class="btn btn-primary-custom" data-bs-toggle="modal" data-bs-target="#addGymModal"><i
                            class="bi bi-plus-lg"></i> New Gym</button>
                </div>

                <div class="row mb-4">
                    <div class="col-md-3">
                        <div class="glass-card p-4 text-center">
                            <div class="h3 fw-bold text-primary" id="stat-gyms">0</div>
                            <div class="text-muted small">Active Gyms</div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="glass-card p-4 text-center">
                            <div class="h3 fw-bold text-success" id="stat-revenue">PKR 0</div>
                            <div class="text-muted small">Total Revenue</div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="glass-card p-4 text-center">
                            <div class="h3 fw-bold text-warning" id="stat-pending">0</div>
                            <div class="text-muted small">Pending Sessions</div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="glass-card p-4 text-center">
                            <div class="h3 fw-bold text-info" id="stat-bookings">0</div>
                            <div class="text-muted small">Total Bookings</div>
                        </div>
                    </div>
                </div>

                <div class="glass-card p-4 mb-4">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h5 class="mb-0">Manage Gyms</h5>
                        <button class="btn btn-sm btn-primary-custom" data-bs-toggle="modal"
                            data-bs-target="#addGymModal"><i class="bi bi-plus-lg"></i> Add Gym</button>
                    </div>
                    <div class="table-responsive">
                        <table class="table table-custom">
                            <thead>
                                <tr>
                                    <th>Image</th>
                                    <th>Name</th>
                                    <th>Location</th>
                                    <th>Price</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="admin-gyms-tbody">
                                <!-- Dynamic Content -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <div class="glass-card p-4">
                    <h5 class="mb-4">Session Requests</h5>
                    <div class="table-responsive">
                        <table class="table table-custom">
                            <thead>
                                <tr>
                                    <th>Member</th>
                                    <th>Gym</th>
                                    <th>Date</th>
                                    <th>Slot</th>
                                    <th>Status</th>
                                    <th>Action</th>
                                </tr>
                            </thead>
                            <tbody id="admin-bookings-tbody">
                                <!-- Dynamic Content -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Add/Edit Gym Modal -->
    <div class="modal fade" id="addGymModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content glass-card bg-dark">
                <div class="modal-header border-bottom border-secondary">
                    <h5 class="modal-title text-white" id="modal-title">Add New Gym</h5><button type="button"
                        class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="add-gym-form">
                        <input type="hidden" id="gym-id">
                        <div class="mb-2"><label class="form-label text-muted small">Gym Name</label><input type="text"
                                id="gym-name" class="form-control form-control-custom" required></div>
                        <div class="mb-2"><label class="form-label text-muted small">Location (City)</label><input
                                type="text" id="gym-location" class="form-control form-control-custom" required></div>
                        <div class="mb-2"><label class="form-label text-muted small">Address</label><input type="text"
                                id="gym-address" class="form-control form-control-custom" required></div>
                        <div class="mb-2"><label class="form-label text-muted small">Capacity</label><input
                                type="number" id="gym-cap" class="form-control form-control-custom" required></div>
                        <div class="mb-2"><label class="form-label text-muted small">Monthly Price (PKR)</label><input
                                type="number" id="gym-price" class="form-control form-control-custom" required></div>
                        <div class="mb-2"><label class="form-label text-muted small">Facilities (comma
                                separated)</label><input type="text" id="gym-facilities"
                                class="form-control form-control-custom" placeholder="Cardio, Weights"></div>
                        <div class="mb-2"><label class="form-label text-muted small">Contact</label><input type="text"
                                id="gym-contact" class="form-control form-control-custom" required></div>
                        <div class="mb-2"><label class="form-label text-muted small">Image URL</label><input type="url"
                                id="gym-img" class="form-control form-control-custom" placeholder="https://..."></div>
                        <div class="row">
                            <div class="col-6 mb-2"><label class="form-label text-muted small">Opening</label><input
                                    type="time" id="gym-open" class="form-control form-control-custom" value="06:00"
                                    required></div>
                            <div class="col-6 mb-2"><label class="form-label text-muted small">Closing</label><input
                                    type="time" id="gym-close" class="form-control form-control-custom" value="22:00"
                                    required></div>
                        </div>
                        <button type="submit" class="btn btn-primary-custom w-100 mt-3" id="btn-save-gym">Save
                            Gym</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <script type="module">
        import utils from './js/utils.js';
        import admin from './js/admin.js';
        import responsive from './js/responsive.js';

        const socket = io('http://localhost:3000');
        let allGyms = [];

        socket.on('gym_added', (newGym) => {
            loadGyms();
            utils.showAlert(`Sync: New gym "${newGym.name}" added!`, 'info');
        });
        socket.on('gym_updated', (updatedGym) => {
            loadGyms();
            utils.showAlert(`Sync: Gym "${updatedGym.name}" updated!`, 'info');
        });
        socket.on('gym_deleted', (id) => {
            loadGyms();
            utils.showAlert('Sync: Gym deleted!', 'warning');
        });

        socket.on('booking_added', (newBooking) => {
            loadStats();
            loadAdminBookings();
            utils.showAlert('New Booking Received!', 'info');
        });

        async function init() {
            if (!utils.checkAuth('ADMIN')) return;
            loadStats();
            loadGyms();
            loadAdminBookings();
            document.getElementById('logout-btn').onclick = utils.logout;
            document.getElementById('add-gym-form').onsubmit = handleSaveGym;

            // Reset modal on close
            document.getElementById('addGymModal').addEventListener('hidden.bs.modal', () => {
                document.getElementById('add-gym-form').reset();
                document.getElementById('gym-id').value = '';
                document.getElementById('modal-title').textContent = 'Add New Gym';
            });
        }

        async function loadStats() {
            const stats = await admin.getStats();
            document.getElementById('stat-gyms').textContent = stats.totalGyms;
            document.getElementById('stat-revenue').textContent = utils.formatCurrency(stats.totalRevenue);
            document.getElementById('stat-pending').textContent = stats.pendingBookings;
            document.getElementById('stat-bookings').textContent = stats.totalBookings;
        }

        async function loadGyms() {
            allGyms = await utils.fetchData('gyms');
            const tbody = document.getElementById('admin-gyms-tbody');
            tbody.innerHTML = allGyms.map(g => `
                <tr>
                    <td><img src="${g.image}" class="rounded" width="40" height="40" style="object-fit:cover;"></td>
                    <td>${g.name}</td>
                    <td>${g.location}</td>
                    <td>${utils.formatCurrency(g.price)}</td>
                    <td><span class="badge bg-success">${g.status}</span></td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary me-1" onclick="window.editGym('${g.id}')"><i class="bi bi-pencil"></i></button>
                        <button class="btn btn-sm btn-outline-danger" onclick="window.deleteGym('${g.id}')"><i class="bi bi-trash"></i></button>
                    </td>
                </tr>
             `).join('');
            document.getElementById('stat-gyms').textContent = allGyms.length;
        }

        window.editGym = (id) => {
            const gym = allGyms.find(g => g.id === id);
            if (!gym) return;
            document.getElementById('gym-id').value = gym.id;
            document.getElementById('gym-name').value = gym.name;
            document.getElementById('gym-location').value = gym.location;
            document.getElementById('gym-address').value = gym.address;
            document.getElementById('gym-cap').value = gym.capacity;
            document.getElementById('gym-price').value = gym.price;
            document.getElementById('gym-facilities').value = (gym.facilities || []).join(', ');
            document.getElementById('gym-contact').value = gym.contact || '';
            document.getElementById('gym-img').value = gym.image;
            document.getElementById('gym-open').value = gym.openingTime;
            document.getElementById('gym-close').value = gym.closingTime;

            document.getElementById('modal-title').textContent = 'Edit Gym';
            new bootstrap.Modal(document.getElementById('addGymModal')).show();
        }

        window.deleteGym = async (id) => {
            if (confirm('Are you sure you want to delete this gym?')) {
                await utils.deleteData('gyms', id);
            }
        }

        async function handleSaveGym(e) {
            e.preventDefault();
            const id = document.getElementById('gym-id').value;
            const data = {
                name: document.getElementById('gym-name').value,
                location: document.getElementById('gym-location').value,
                address: document.getElementById('gym-address').value,
                capacity: parseInt(document.getElementById('gym-cap').value),
                price: parseInt(document.getElementById('gym-price').value),
                facilities: document.getElementById('gym-facilities').value.split(',').map(s => s.trim()),
                contact: document.getElementById('gym-contact').value,
                image: document.getElementById('gym-img').value,
                openingTime: document.getElementById('gym-open').value,
                closingTime: document.getElementById('gym-close').value,
                status: "Open"
            };

            if (id) {
                await utils.updateData('gyms', id, data);
            } else {
                await utils.postData('gyms', data);
            }

            // Close modal
            const modalEl = document.getElementById('addGymModal');
            const modal = bootstrap.Modal.getInstance(modalEl);
            modal.hide();
        }

        async function loadAdminBookings() {
            const list = await admin.getAllBookingsDetailed();
            const body = document.getElementById('admin-bookings-tbody');
            if (!list || list.length === 0) {
                body.innerHTML = '<tr><td colspan="6" class="text-center text-muted">No pending requests.</td></tr>';
                return;
            }
            body.innerHTML = list.map(b => `
                <tr>
                    <td>${b.user?.name || b.userName || 'Guest'}</td>
                    <td>${b.gym?.name || 'Unknown Gym'}</td>
                    <td>${b.date}</td>
                    <td>${b.slot}</td>
                    <td><span class="badge ${getStatusClass(b.status)}">${b.status}</span></td>
                    <td>
                        ${b.status === 'Pending' ? `
                            <button class="btn btn-sm btn-success" onclick="window.updateStatus('${b.id}', 'Confirmed')"><i class="bi bi-check"></i></button>
                            <button class="btn btn-sm btn-danger" onclick="window.updateStatus('${b.id}', 'Cancelled')"><i class="bi bi-x"></i></button>
                        ` : '-'}
                    </td>
                </tr>
            `).join('');
        }

        function getStatusClass(s) {
            return s === 'Confirmed' ? 'bg-success' : s === 'Pending' ? 'bg-warning text-dark' : 'bg-danger';
        }

        window.updateStatus = async (id, status) => {
            await admin.updateBookingStatus(id, status);
            loadStats();
            loadAdminBookings();
        }

        init();
    </script>
</body>

</html>