<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Member Dashboard | Iron Pulse</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <link rel="stylesheet" href="css/style.css">
</head>

<body>
    <div class="container-fluid">
        <div class="row">
            <!-- Sidebar -->
            <nav class="col-md-3 col-lg-2 d-md-block sidebar collapse p-0">
                <div class="position-sticky pt-4">
                    <div class="text-center mb-4">
                        <h4 class="text-white fw-bold"><i class="bi bi-lightning-charge-fill text-primary"></i> IRON
                            PULSE</h4>
                    </div>
                    <ul class="nav flex-column">
                        <li class="nav-item"><a class="sidebar-link active" href="dashboard.html"><i
                                    class="bi bi-speedometer2 me-2"></i> Overview</a></li>
                        <li class="nav-item"><a class="sidebar-link" href="index.html"><i class="bi bi-search me-2"></i>
                                Browse Gyms</a></li>
                        <li class="nav-item"><a class="sidebar-link" href="payments.html"><i
                                    class="bi bi-credit-card me-2"></i> Payments</a></li>
                        <li class="nav-item mt-5"><button class="sidebar-link w-100 text-start border-0 bg-transparent"
                                id="logout-btn"><i class="bi bi-box-arrow-right me-2"></i> Logout</button></li>
                    </ul>
                </div>
            </nav>

            <!-- Main Content -->
            <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4 py-4">
                <div id="alert-container"></div>
                <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-4">
                    <h1 class="h2">Welcome, <span id="user-name">Member</span>!</h1>
                </div>

                <div class="row mb-4">
                    <!-- Profile Card -->
                    <div class="col-md-4 mb-3">
                        <div class="glass-card p-3">
                            <h6 class="text-muted mb-2">My Profile</h6>
                            <p class="mb-1 text-white" id="p-name"></p>
                            <p class="mb-1 text-muted small" id="p-email"></p>
                            <p class="mb-0 text-muted small" id="p-phone"></p>
                            <button class="btn btn-sm btn-outline-primary mt-3" data-bs-toggle="modal"
                                data-bs-target="#editProfileModal">Update Info</button>
                        </div>
                    </div>
                    <!-- Quick Book -->
                    <div class="col-md-8">
                        <div class="glass-card p-3">
                            <h6 class="text-muted mb-3">Book a New Session</h6>
                            <form id="quick-book-form" class="row g-2">
                                <div class="col-md-4">
                                    <select id="gym-select" class="form-select form-control-custom" required>
                                        <option value="">Select Gym</option>
                                    </select>
                                </div>
                                <div class="col-md-3">
                                    <input type="date" id="book-date" class="form-control form-control-custom" required>
                                </div>
                                <div class="col-md-3">
                                    <select id="book-slot" class="form-select form-control-custom" required>
                                        <option value="">Select Slot</option>
                                        <option value="06:00 - 08:00">Early Morning</option>
                                        <option value="08:00 - 10:00">Morning</option>
                                        <option value="16:00 - 18:00">Evening</option>
                                        <option value="18:00 - 20:00">Late Evening</option>
                                        <option value="20:00 - 22:00">Night</option>
                                    </select>
                                </div>
                                <div class="col-md-2">
                                    <button type="submit" class="btn btn-primary-custom w-100">Book</button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>

                <!-- Bookings Table -->
                <div class="glass-card p-4">
                    <h5 class="mb-4">Recent Bookings</h5>
                    <div class="table-responsive">
                        <table class="table table-custom">
                            <thead>
                                <tr>
                                    <th>Gym</th>
                                    <th>Date</th>
                                    <th>Slot</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="bookings-tbody">
                                <tr>
                                    <td colspan="5" class="text-center text-muted py-3">Loading your bookings...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Edit Profile Modal -->
    <div class="modal fade" id="editProfileModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content glass-card bg-dark">
                <div class="modal-header border-bottom border-secondary">
                    <h5 class="modal-title text-white">Edit Profile</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="edit-profile-form">
                        <div class="mb-3">
                            <label class="form-label text-muted">Full Name</label>
                            <input type="text" id="edit-name" class="form-control form-control-custom" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label text-muted">Phone Number</label>
                            <input type="tel" id="edit-phone" class="form-control form-control-custom" required>
                        </div>
                        <button type="submit" class="btn btn-primary-custom w-100">Save Changes</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <script type="module">
        import utils from './js/utils.js';
        import bookings from './js/bookings.js';
        import responsive from './js/responsive.js';

        let currentUser = null;
        const socket = io('http://localhost:3000');

        // Listen for updates to my bookings
        socket.on('booking_updated', (updatedBooking) => {
            if (currentUser && updatedBooking.userId === currentUser.id) {
                // If the update belongs to me, reload list and notify
                loadBookings();
                if (updatedBooking.status === 'Confirmed') {
                    utils.showAlert(`Good news! Your booking at ${updatedBooking.gym ? updatedBooking.gym.name : 'the gym'} is Confirmed!`, 'success');
                } else if (updatedBooking.status === 'Cancelled') {
                    utils.showAlert(`Your booking has been Cancelled.`, 'warning');
                }
            }
        });

        async function init() {
            currentUser = utils.checkAuth('USER');
            if (!currentUser) return;

            document.getElementById('user-name').textContent = currentUser.name;
            document.getElementById('p-name').textContent = currentUser.name;
            document.getElementById('p-email').textContent = currentUser.email;
            document.getElementById('p-phone').textContent = currentUser.phone;
            document.getElementById('edit-name').value = currentUser.name;
            document.getElementById('edit-phone').value = currentUser.phone;

            const allGyms = await utils.fetchData('gyms');
            const gymSelect = document.getElementById('gym-select');
            allGyms.forEach(g => {
                const opt = document.createElement('option');
                opt.value = g.id;
                opt.textContent = `${g.name} (${g.city})`;
                gymSelect.appendChild(opt);
            });

            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.get('gymId')) gymSelect.value = urlParams.get('gymId');

            loadBookings();

            document.getElementById('logout-btn').onclick = utils.logout;
            document.getElementById('quick-book-form').onsubmit = handleBooking;
            document.getElementById('edit-profile-form').onsubmit = handleProfileUpdate;
        }

        async function loadBookings() {
            const list = await bookings.getUserBookings(currentUser.id);
            const body = document.getElementById('bookings-tbody');

            if (!list || list.length === 0) {
                body.innerHTML = '<tr><td colspan="5" class="text-center text-muted">No bookings found yet.</td></tr>';
                return;
            }

            body.innerHTML = list.map(b => `
                <tr>
                    <td>${b.gym ? b.gym.name : 'Unknown Gym'}</td>
                    <td>${b.date}</td>
                    <td>${b.slot}</td>
                    <td><span class="badge ${getStatusClass(b.status)}">${b.status}</span></td>
                    <td>
                        ${b.status === 'Pending' ? `<button class="btn btn-sm btn-outline-danger" onclick="window.cancelBooking('${b.id}')">Cancel</button>` : '-'}
                    </td>
                </tr>
            `).join('');
        }

        function getStatusClass(status) {
            switch (status) {
                case 'Confirmed': return 'bg-success';
                case 'Pending': return 'bg-warning text-dark';
                case 'Cancelled': return 'bg-danger';
                case 'Completed': return 'bg-info';
                default: return 'bg-secondary';
            }
        }

        async function handleBooking(e) {
            e.preventDefault();
            const data = {
                userId: currentUser.id,
                userName: currentUser.name,
                userPhone: currentUser.phone,
                gymId: document.getElementById('gym-select').value,
                date: document.getElementById('book-date').value,
                slot: document.getElementById('book-slot').value
            };
            const res = await bookings.createBooking(data);
            if (res) loadBookings();
        }

        async function handleProfileUpdate(e) {
            e.preventDefault();
            const updated = {
                ...currentUser,
                name: document.getElementById('edit-name').value,
                phone: document.getElementById('edit-phone').value
            };
            const res = await utils.updateData('users', currentUser.id, updated);
            if (res) {
                localStorage.setItem('currentUser', JSON.stringify(res));
                location.reload();
            }
        }

        window.cancelBooking = async (id) => {
            if (confirm('Cancel this booking?')) {
                await bookings.cancelBooking(id);
                loadBookings();
            }
        };

        init();
    </script>
</body>

</html>